import { useState, useEffect } from "react";
import { useQuery, useMutation } from "@tanstack/react-query";
import { useLocation, useRoute } from "wouter";
import { z } from "zod";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
  CardFooter,
} from "@/components/ui/card";
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Separator } from "@/components/ui/separator";
import { Badge } from "@/components/ui/badge";
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/components/ui/collapsible";
import { Loader2, ArrowLeft, ChevronDown, ChevronUp, AlertTriangle, MapPin, UserRound, Package, CreditCard, Copy, RefreshCcw, Edit, Save, X, Box, Weight, Info, StickyNote, FileText } from "lucide-react";
import { apiRequest, queryClient } from "@/lib/queryClient";
import { COUNTRIES } from "@/lib/countries";
import { withAuth } from "@/lib/with-auth";
import { useToast } from "@/hooks/use-toast";
import { ShipmentStatus, ServiceLevel } from "@shared/schema";
import Layout from "@/components/layout";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

// Currency options
const CURRENCIES = [
  { code: "USD", name: "US Dollar", symbol: "$" },
  { code: "EUR", name: "Euro", symbol: "€" },
  { code: "GBP", name: "British Pound", symbol: "£" },
  { code: "TRY", name: "Turkish Lira", symbol: "₺" },
  { code: "JPY", name: "Japanese Yen", symbol: "¥" },
  { code: "CAD", name: "Canadian Dollar", symbol: "C$" },
];

// Schema for editing shipment
const editShipmentSchema = z.object({
  // Sender details
  senderName: z.string().min(1, "Sender name is required"),
  senderAddress: z.string().optional(),
  senderCity: z.string().optional(),
  senderPostalCode: z.string().optional(),
  senderPhone: z.string().optional(),
  senderEmail: z.string().optional(),
  
  // Receiver details
  receiverName: z.string().min(1, "Receiver name is required"),
  receiverAddress: z.string().min(1, "Receiver address is required"),
  receiverCity: z.string().min(1, "Receiver city is required"),
  receiverPostalCode: z.string().min(1, "Receiver postal code is required"),
  receiverCountry: z.string().min(1, "Receiver country is required"),
  receiverPhone: z.string().min(1, "Receiver phone is required"),
  receiverEmail: z.string().email("Invalid email address").optional().or(z.literal('')),
  receiverState: z.string().optional(),
  
  // Package details
  packageWeight: z.preprocess(
    (val) => (val === "" ? 0 : Number(val)),
    z.number().min(0.1, "Weight must be greater than 0")
  ),
  packageLength: z.preprocess(
    (val) => (val === "" ? 0 : Number(val)),
    z.number().min(1, "Length must be greater than 0")
  ),
  packageWidth: z.preprocess(
    (val) => (val === "" ? 0 : Number(val)),
    z.number().min(1, "Width must be greater than 0")
  ),
  packageHeight: z.preprocess(
    (val) => (val === "" ? 0 : Number(val)),
    z.number().min(1, "Height must be greater than 0")
  ),
  packageContents: z.string().optional(),
  pieceCount: z.preprocess(
    (val) => (val === "" ? 1 : Number(val)),
    z.number().min(1, "Piece count must be at least 1")
  ),
  itemCount: z.preprocess(
    (val) => (val === "" ? 1 : Number(val)),
    z.number().min(1, "Item count must be at least 1")
  ),
  
  // Customs details
  gtip: z.string().optional(),
  customsValue: z.preprocess(
    (val) => (val === "" ? 0 : Number(val)),
    z.number().min(0, "Customs value cannot be negative")
  ),
  currency: z.string().default("USD"),
  
  // Service details
  serviceLevel: z.enum([ServiceLevel.STANDARD, ServiceLevel.EXPRESS, ServiceLevel.PRIORITY]),
  
  // Pricing details
  basePrice: z.number().optional(),
  fuelCharge: z.number().optional(),
  totalPrice: z.number().optional(),
  
  // Status
  status: z.enum([
    ShipmentStatus.PENDING, 
    ShipmentStatus.APPROVED, 
    ShipmentStatus.REJECTED
  ]),
  
  // Rejection reason (only required if status is REJECTED)
  rejectionReason: z.string().optional().superRefine((val, ctx) => {
    try {
      // Only apply this validation when used in the main shipment form context
      const parent = ctx.path[0] === '' ? ctx.data : undefined;
      if (parent && 'status' in parent && parent.status === ShipmentStatus.REJECTED) {
        if (!val || val.length === 0) {
          ctx.addIssue({
            code: z.ZodIssueCode.custom,
            message: "Rejection reason is required when status is Rejected",
          });
        }
      }
    } catch (error) {
      console.error("Error in rejectionReason validation:", error);
    }
    return z.NEVER;
  }),
});

type EditShipmentFormValues = z.infer<typeof editShipmentSchema>;

// Format price for display
const formatPrice = (price?: number) => {
  if (price === undefined || price === null) return "N/A";
  return `$${(price / 100).toFixed(2)}`;
};

// Format date
const formatDate = (dateString?: string) => {
  if (!dateString) return "N/A";
  const date = new Date(dateString);
  return new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
    hour: "numeric",
    minute: "numeric",
  }).format(date);
};

// Collapsible section component
const SectionCard = ({ 
  title, 
  icon, 
  children, 
  defaultOpen = false,
  bgColor = "bg-gray-50" 
}) => {
  const [isOpen, setIsOpen] = useState(defaultOpen);
  
  const Icon = icon;
  
  return (
    <Collapsible
      open={isOpen}
      onOpenChange={setIsOpen}
      className={`border rounded-lg ${bgColor} mb-4 overflow-hidden`}
    >
      <CollapsibleTrigger asChild>
        <div className="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-100">
          <div className="flex items-center space-x-2">
            <Icon className="h-5 w-5 text-gray-600" />
            <h3 className="text-lg font-medium">{title}</h3>
          </div>
          {isOpen ? (
            <ChevronUp className="h-5 w-5 text-gray-500" />
          ) : (
            <ChevronDown className="h-5 w-5 text-gray-500" />
          )}
        </div>
      </CollapsibleTrigger>
      <CollapsibleContent>
        <div className="p-4 pt-0">
          {children}
        </div>
      </CollapsibleContent>
    </Collapsible>
  );
};

type ShipmentEditProps = {
  user: any;
};

const ShipmentEditContent = ({ user }: ShipmentEditProps) => {
  const [, setLocation] = useLocation();
  const [match, params] = useRoute("/shipment-edit/:id");
  const { toast } = useToast();
  const shipmentId = params?.id ? parseInt(params.id) : null;
  const isAdmin = user && user.role === 'admin';
  
  // State for editing packages
  const [editingPackageId, setEditingPackageId] = useState<number | null>(null);
  const [editingPackageData, setEditingPackageData] = useState<PackageEditData | null>(null);
  // Add state for real-time volumetric and billable weight calculation during editing
  const [editingVolumetricWeight, setEditingVolumetricWeight] = useState<number>(0);
  const [editingBillableWeight, setEditingBillableWeight] = useState<number>(0);
  
  // Define schema for package editing data (separate from shipment schema)
  const packageEditSchema = z.object({
    name: z.string(),
    description: z.string().optional(),
    notes: z.string().optional(),
    // Allow both string and number inputs, but require values > 0 (not just >= 0)
    // since the DB stores them as strings but the UI works with them as numbers
    weight: z.union([
      z.string().refine(val => !isNaN(parseFloat(val)) && parseFloat(val) > 0, "Weight must be greater than 0"),
      z.number().refine(val => val > 0, "Weight must be greater than 0"),
    ]),
    length: z.union([
      z.string().refine(val => !isNaN(parseFloat(val)) && parseFloat(val) > 0, "Length must be greater than 0"),
      z.number().refine(val => val > 0, "Length must be greater than 0"),
    ]),
    width: z.union([
      z.string().refine(val => !isNaN(parseFloat(val)) && parseFloat(val) > 0, "Width must be greater than 0"),
      z.number().refine(val => val > 0, "Width must be greater than 0"),
    ]),
    height: z.union([
      z.string().refine(val => !isNaN(parseFloat(val)) && parseFloat(val) > 0, "Height must be greater than 0"),
      z.number().refine(val => val > 0, "Height must be greater than 0"),
    ]),
  });
  
  // Define type for package editing data
  type PackageEditData = z.infer<typeof packageEditSchema>;

  // Function to refresh packages after an update
  const refreshPackages = async () => {
    // Invalidate the shipment cache to force a refresh
    await queryClient.invalidateQueries({ queryKey: [`/api/shipments/${shipmentId}`] });
    
    // Also fetch fresh package data and update the local state
    try {
      const response = await fetch(`/api/shipments/${shipmentId}`, {
        credentials: 'include',
        headers: {
          'Accept': 'application/json'
        }
      });
      
      if (response.ok) {
        const shipmentData = await response.json();
        
        if (shipmentData.packages && Array.isArray(shipmentData.packages)) {
          console.log("Refreshing packages with new data:", shipmentData.packages);
          
          // Create packages based on updated shipment data
          const updatedPackages = shipmentData.packages.map((pkg, index) => {
            // Extract dimensions and weights - ensure they're converted to numbers
            const pkgWeight = typeof pkg.weight === 'number' 
              ? pkg.weight 
              : (pkg.weight ? parseFloat(String(pkg.weight)) : 0);
              
            const pkgLength = typeof pkg.length === 'number' 
              ? pkg.length 
              : (pkg.length ? parseFloat(String(pkg.length)) : 0);
              
            const pkgWidth = typeof pkg.width === 'number' 
              ? pkg.width 
              : (pkg.width ? parseFloat(String(pkg.width)) : 0);
              
            const pkgHeight = typeof pkg.height === 'number' 
              ? pkg.height 
              : (pkg.height ? parseFloat(String(pkg.height)) : 0);
            
            const volumetricWeight = calculateVolumetricWeight(pkgLength, pkgWidth, pkgHeight);
            const billableWeight = Math.max(pkgWeight, volumetricWeight);
            
            return {
              id: pkg.id || index,
              name: pkg.name || `Package #${index + 1}`,
              description: pkg.description || '',
              notes: pkg.notes || '',
              weight: pkgWeight,
              length: pkgLength,
              width: pkgWidth,
              height: pkgHeight,
              volumetricWeight: volumetricWeight,
              billableWeight: billableWeight,
              isUserEntered: true
            };
          });
          
          // Update packages state
          setPackages(updatedPackages);
        }
      }
    } catch (error) {
      console.error("Error refreshing packages:", error);
    }
  };
  
  // Utility function to copy text to clipboard
  const copyToClipboard = (text: string | undefined, field: string) => {
    if (!text) return;
    
    navigator.clipboard.writeText(text).then(
      () => {
        toast({
          title: "Copied!",
          description: `${field} copied to clipboard.`,
        });
      },
      (err) => {
        toast({
          title: "Copy failed",
          description: "Could not copy text to clipboard.",
          variant: "destructive",
        });
        console.error("Could not copy text: ", err);
      }
    );
  };
  
  // Calculate volumetric weight
  const calculateVolumetricWeight = (l: number, w: number, h: number) => {
    return (l * w * h) / 5000;
  };

  // Fetch shipment data
  const {
    data: shipment,
    isLoading: isLoadingShipment,
    isError: isErrorShipment,
  } = useQuery({
    queryKey: [`/api/shipments/${shipmentId}`],
    queryFn: async () => {
      if (!shipmentId) return null;
      const response = await apiRequest("GET", `/api/shipments/${shipmentId}`);
      return response.json();
    },
    enabled: !!shipmentId,
    onSuccess: (data) => {
      // Initialize cost prices from shipment data
      if (data) {
        setCostPrices({
          basePrice: data.originalBasePrice || 0,
          fuelCharge: data.originalFuelCharge || 0,
          totalPrice: data.originalTotalPrice || 0
        });
      }
    }
  });

  // Fetch shipment creator's data if shipment is loaded and userId exists
  const {
    data: shipmentCreator,
    isLoading: isLoadingCreator,
  } = useQuery({
    queryKey: [`/api/users/${shipment?.userId}`],
    queryFn: async () => {
      if (!shipment?.userId) return null;
      const response = await apiRequest("GET", `/api/users/${shipment.userId}`);
      return response.json();
    },
    enabled: !!shipment?.userId && shipment.userId !== user?.id, // Only fetch if shipment and userId exist
  });

  // Setup form
  const form = useForm<EditShipmentFormValues>({
    resolver: zodResolver(editShipmentSchema),
    defaultValues: {
      // Sender details
      senderName: "",
      senderAddress: "",
      senderCity: "",
      senderPostalCode: "",
      senderEmail: "",
      senderPhone: "",
      
      // Receiver details
      receiverName: "",
      receiverAddress: "",
      receiverCity: "",
      receiverPostalCode: "",
      receiverCountry: "",
      receiverPhone: "",
      receiverEmail: "",
      receiverState: "",
      
      // Package details
      packageWeight: 0,
      packageLength: 0,
      packageWidth: 0,
      packageHeight: 0,
      packageContents: "",
      pieceCount: 1,
      itemCount: 1,
      
      // Customs details
      gtip: "",
      customsValue: 0,
      currency: "USD",
      
      // Service details
      serviceLevel: ServiceLevel.STANDARD,
      
      // Status
      status: ShipmentStatus.PENDING,
      rejectionReason: "",
    },
  });

  // Load package items from the API
  const { data: packageItems, isLoading: isLoadingPackageItems } = useQuery({
    queryKey: [`/api/shipments/${shipmentId}/items`],
    queryFn: async () => {
      if (!shipmentId) return [];
      
      try {
        console.log(`Fetching package items for shipment ${shipmentId}`);
        // Fetch package items for this shipment using the correct endpoint
        const response = await fetch(`/api/shipments/${shipmentId}/items`, {
          credentials: 'include', // This ensures cookies are sent with the request
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const items = await response.json();
          console.log(`Successfully fetched ${items.length} package items:`, items);
          
          // Process each item to ensure correct data types for proper display
          const processedItems = items.map(item => {
            console.log("Processing item:", item);
            return {
              ...item,
              // Convert price from cents to dollars/TL (database stores cents)
              price: item.price ? item.price / 100 : 0,
              // Ensure numeric values for dimensions and weights
              weight: typeof item.weight === 'number' ? item.weight : parseFloat(String(item.weight || '0')),
              length: typeof item.length === 'number' ? item.length : parseInt(String(item.length || '0')),
              width: typeof item.width === 'number' ? item.width : parseInt(String(item.width || '0')),
              height: typeof item.height === 'number' ? item.height : parseInt(String(item.height || '0')),
            };
          });
          
          console.log('Processed package items for display:', processedItems);
          return processedItems;
        }
        
        console.error("Error fetching items:", await response.text());
        return [];
      } catch (error) {
        console.error("Error fetching package items:", error);
        return [];
      }
    },
    enabled: !!shipmentId,
    staleTime: 0 // Always refetch to ensure we have the latest data
  });

  // Update form when shipment data is loaded
  useEffect(() => {
    if (shipment) {
      // Find the best GTIP value if we have package items
      let gtipValue = shipment.gtip || "";
      
      // Try to get GTIP from the highest priced item immediately (don't wait for the separate useEffect)
      if (packageItems && packageItems.length > 0) {
        console.log("Immediately processing package items for GTIP during form initialization");
        
        // Sort items by total price (price * quantity) from highest to lowest
        const sortedItems = [...packageItems].sort((a, b) => {
          const aTotal = (a.price || 0) * (a.quantity || 1);
          const bTotal = (b.price || 0) * (b.quantity || 1);
          return bTotal - aTotal; // Descending order
        });
        
        // Get the GTIP (hsCode) from the highest priced item
        const highestPricedItem = sortedItems[0];
        
        // Check all possible field names for GTIP code
        const hsCode = highestPricedItem?.hsCode || highestPricedItem?.gtin || '';
        
        if (hsCode && hsCode.trim() !== '') {
          console.log(`Using hsCode ${hsCode} from highest priced item for initial form value`);
          gtipValue = hsCode;
        } else {
          // Let's try an alternative approach by looking at all the properties
          const itemKeys = Object.keys(highestPricedItem || {});
          
          // Look for any property that might contain GTIP/HS code information
          const gtipRelatedFields = itemKeys.filter(key => 
            key.toLowerCase().includes('hs') || 
            key.toLowerCase().includes('gtip') || 
            key.toLowerCase().includes('code')
          );
          
          if (gtipRelatedFields.length > 0) {
            // Use the first field that has a non-empty value
            for (const field of gtipRelatedFields) {
              const value = highestPricedItem[field];
              if (value && typeof value === 'string' && value.trim() !== '') {
                console.log(`Using value ${value} from field ${field} for initial GTIP`);
                gtipValue = value;
                break;
              }
            }
          }
        }
      }
      
      form.reset({
        // Sender details
        senderName: shipment.senderName || "",
        senderAddress: shipment.senderAddress || "",
        senderCity: shipment.senderCity || "",
        senderPostalCode: shipment.senderPostalCode || "",
        senderEmail: shipment.senderEmail || "",
        senderPhone: shipment.senderPhone || "",
        
        // Receiver details
        receiverName: shipment.receiverName,
        receiverAddress: shipment.receiverAddress,
        receiverCity: shipment.receiverCity,
        receiverPostalCode: shipment.receiverPostalCode,
        receiverCountry: shipment.receiverCountry,
        receiverPhone: shipment.receiverPhone,
        receiverEmail: shipment.receiverEmail,
        receiverState: shipment.receiverState || "",
        
        // Package details
        packageWeight: shipment.packageWeight,
        packageLength: shipment.packageLength,
        packageWidth: shipment.packageWidth,
        packageHeight: shipment.packageHeight,
        
        // New custom fields
        packageContents: shipment.packageContents || "",
        pieceCount: shipment.pieceCount || 1,
        itemCount: shipment.customsItemCount || packageItems?.length || 1, // Use customs item count from DB, fallback to items length
        gtip: gtipValue, // Use our determined GTIP value
        customsValue: shipment.customsValue || 0,
        currency: shipment.currency || "USD",
        
        // Original fields
        serviceLevel: shipment.serviceLevel,
        basePrice: shipment.basePrice,
        fuelCharge: shipment.taxes, // Using existing taxes field in DB
        totalPrice: shipment.totalPrice,
        status: shipment.status,
        rejectionReason: shipment.rejectionReason || "",
      });
      
      // Create packages based on actual shipment data
      const shipmentPackages = [];
      
      // Check if the shipment has packages data
      if (shipment.packages && Array.isArray(shipment.packages) && shipment.packages.length > 0) {
        console.log("Using shipment packages data:", shipment.packages);
        
        // Use the packages data from the shipment
        shipment.packages.forEach((pkg, index) => {
          try {
            // Extract dimensions and weights - ensure they're converted to numbers
            const pkgWeight = typeof pkg.weight === 'number' 
              ? pkg.weight 
              : (pkg.weight ? parseFloat(String(pkg.weight)) : 0);
              
            const pkgLength = typeof pkg.length === 'number' 
              ? pkg.length 
              : (pkg.length ? parseFloat(String(pkg.length)) : 0);
              
            const pkgWidth = typeof pkg.width === 'number' 
              ? pkg.width 
              : (pkg.width ? parseFloat(String(pkg.width)) : 0);
              
            const pkgHeight = typeof pkg.height === 'number' 
              ? pkg.height 
              : (pkg.height ? parseFloat(String(pkg.height)) : 0);
            
            const volumetricWeight = calculateVolumetricWeight(pkgLength, pkgWidth, pkgHeight);
            const billableWeight = Math.max(pkgWeight, volumetricWeight);
            
            console.log(`Adding shipment package #${index + 1}: ${pkg.name || 'Package'} - ${pkgLength}x${pkgWidth}x${pkgHeight}cm, ${pkgWeight}kg`);
            
            // Create a package object using the actual package data from the shipment
            shipmentPackages.push({
              id: pkg.id || index,
              name: pkg.name || `Package #${index + 1}`,
              description: pkg.description || '',
              notes: pkg.notes || '',
              weight: pkgWeight,
              length: pkgLength,
              width: pkgWidth,
              height: pkgHeight,
              volumetricWeight: volumetricWeight,
              billableWeight: billableWeight,
              isUserEntered: true
            });
          } catch (error) {
            console.error(`Error processing package #${index}:`, error, pkg);
          }
        });
      } else {
        // Fallback to main package data from the shipment if no packages array
        console.log("No dedicated packages array found, using main package data");
        
        // Get piece count from the shipment data
        const pieceCount = shipment.pieceCount || 1;
        console.log(`Creating ${pieceCount} packages based on pieceCount`);
        
        // Add a special note that explains what's happening when we have multiple packages
        // but only one set of dimensions
        const explanationNote = (pieceCount > 1) 
          ? "Note: These are identical physical packages created based on the piece count you entered. " +
            "The original dimensions and weight you entered apply to each package."
          : "";
            
        // Create as many packages as the pieceCount value indicates
        for (let i = 0; i < pieceCount; i++) {
          const packageWeight = shipment.packageWeight || 0;
          const packageLength = shipment.packageLength || 0;
          const packageWidth = shipment.packageWidth || 0;
          const packageHeight = shipment.packageHeight || 0;
          
          const volumetricWeight = calculateVolumetricWeight(
            packageLength, 
            packageWidth, 
            packageHeight
          );
          
          const billableWeight = Math.max(
            packageWeight, 
            volumetricWeight
          );
          
          shipmentPackages.push({
            id: i + 1,
            name: pieceCount === 1 ? "Main Package" : `Package #${i + 1}`,
            weight: packageWeight,
            length: packageLength,
            width: packageWidth,
            height: packageHeight,
            volumetricWeight: volumetricWeight,
            billableWeight: billableWeight,
            isUserEntered: true,
            description: i === 0 && explanationNote ? explanationNote : "",
            notes: ""
          });
        }
      }
      
      // If we have package items data available (product contents), we can link them to packages
      // but we don't use them as the primary package display
      console.log("Product items from API:", packageItems);
      
      console.log("Final shipment packages:", shipmentPackages);
      
      setPackages(shipmentPackages);
    }
  }, [shipment, form, packageItems]);

  // Fallback useEffect for GTIP auto-population in case items load after initial form setup
  useEffect(() => {
    // Only run this if the form's current gtip value is empty (indicating the initial useEffect didn't set it)
    const currentGtipValue = form.getValues("gtip");
    
    console.log("Package items secondary useEffect triggered", {
      hasItems: !!packageItems,
      itemCount: packageItems?.length || 0,
      currentGtipValue
    });
    
    // Skip this useEffect if we already have a GTIP value
    if (currentGtipValue && currentGtipValue.trim() !== '') {
      console.log("GTIP value already exists, skipping auto-population:", currentGtipValue);
      return;
    }
    
    // Only process if we have package items and they're loaded
    if (packageItems && packageItems.length > 0) {
      console.log("Processing package items for fallback GTIP auto-population");
      
      // Sort items by total price (price * quantity) from highest to lowest
      const sortedItems = [...packageItems].sort((a, b) => {
        const aTotal = (a.price || 0) * (a.quantity || 1);
        const bTotal = (b.price || 0) * (b.quantity || 1);
        return bTotal - aTotal; // Descending order
      });
      
      // Get the GTIP (hsCode) from the highest priced item
      const highestPricedItem = sortedItems[0];
      
      // Check all possible field names for GTIP code
      const hsCode = highestPricedItem?.hsCode || highestPricedItem?.gtin || '';
      
      console.log("Highest priced item for fallback:", {
        item: highestPricedItem,
        hsCode: hsCode,
        allProperties: Object.keys(highestPricedItem || {})
      });
      
      // Only update if hsCode exists and is not empty
      if (hsCode && hsCode.trim() !== '') {
        // Use setValue instead of modifying the form values directly
        form.setValue("gtip", hsCode);
        console.log(`Fallback: Auto-populated GTIP field with ${hsCode}`);
      } else {
        // Let's try an alternative approach by looking at all the properties
        const itemKeys = Object.keys(highestPricedItem || {});
        
        // Look for any property that might contain GTIP/HS code information
        const gtipRelatedFields = itemKeys.filter(key => 
          key.toLowerCase().includes('hs') || 
          key.toLowerCase().includes('gtip') || 
          key.toLowerCase().includes('code')
        );
        
        if (gtipRelatedFields.length > 0) {
          console.log("Found potential GTIP-related fields for fallback:", gtipRelatedFields);
          
          // Use the first field that has a non-empty value
          for (const field of gtipRelatedFields) {
            const value = highestPricedItem[field];
            if (value && typeof value === 'string' && value.trim() !== '') {
              form.setValue("gtip", value);
              console.log(`Fallback: Auto-populated GTIP field with ${value} from field ${field}`);
              break;
            }
          }
        }
      }
    }
  }, [packageItems, form]);

  // Watch for form changes to recalculate price
  const weight = form.watch("packageWeight");
  const length = form.watch("packageLength");
  const width = form.watch("packageWidth");
  const height = form.watch("packageHeight");
  const serviceLevel = form.watch("serviceLevel");

  // Calculate the billable weight (greater of actual weight vs volumetric weight)
  const volumetricWeight = 
    length && width && height 
      ? calculateVolumetricWeight(length, width, height) 
      : 0;
  
  const billableWeight = Math.max(weight || 0, volumetricWeight);
  
  // State to track original pricing before applying multiplier
  const [costPrices, setCostPrices] = useState({
    basePrice: 0,
    fuelCharge: 0,
    totalPrice: 0
  });
  
  // State to track multiple packages
  const [packages, setPackages] = useState<{
    id: number;
    name?: string;
    description?: string;
    notes?: string;
    weight: number;
    length: number;
    width: number;
    height: number;
    volumetricWeight: number;
    billableWeight: number;
    isUserEntered?: boolean;
    quantity?: number;
    price?: number;
    hsCode?: string;
    countryOfOrigin?: string;
    gtin?: string;
  }[]>([]);
  
  // Function to calculate price based on current package details
  const calculatePrice = async () => {
    try {
      toast({
        title: "Calculating Price",
        description: "Requesting price from shipping carrier..."
      });
      
      // Calculate total billable weight from all packages
      let totalBillableWeight = 0;
      
      // For each package, get its billable weight and add to the total
      packages.forEach(pkg => {
        const pkgBillableWeight = typeof pkg.billableWeight === 'number' ? pkg.billableWeight : 0;
        totalBillableWeight += pkgBillableWeight;
      });
      
      // If no packages or billable weight is 0, fall back to form values
      if (totalBillableWeight === 0 || packages.length === 0) {
        // Fall back to package dimensions from form
        const packageLength = form.getValues("packageLength") || 0;
        const packageWidth = form.getValues("packageWidth") || 0;
        const packageHeight = form.getValues("packageHeight") || 0;
        const packageWeight = form.getValues("packageWeight") || 0;
        
        // Calculate volumetric weight
        const volumetricWeight = calculateVolumetricWeight(
          packageLength,
          packageWidth,
          packageHeight
        );
        
        // Use max of actual or volumetric
        totalBillableWeight = Math.max(packageWeight, volumetricWeight);
      }
      
      console.log(`Using total billable weight for pricing: ${totalBillableWeight.toFixed(2)} kg`);
      
      // Get all the required values from the form
      const requestData = {
        senderPostalCode: form.getValues("senderPostalCode") || "34001", // Default if not available
        senderCity: form.getValues("senderCity") || "Istanbul", // Default if not available
        receiverPostalCode: form.getValues("receiverPostalCode"),
        receiverCity: form.getValues("receiverCity"),
        receiverCountry: form.getValues("receiverCountry"),
        packageLength: form.getValues("packageLength"),
        packageWidth: form.getValues("packageWidth"),
        packageHeight: form.getValues("packageHeight"),
        // Use the calculated billable weight for pricing
        packageWeight: totalBillableWeight,
        serviceLevel: form.getValues("serviceLevel"),
        pieceCount: form.getValues("pieceCount") || packages.length || 1,
        userId: shipment?.userId // Include user ID for correct multiplier application
      };
      
      // Call API to calculate price
      const response = await apiRequest("POST", "/api/calculate-price", requestData);
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || "Failed to calculate price");
      }
      
      const priceData = await response.json();
      
      // Store original cost prices before multiplier
      setCostPrices({
        basePrice: priceData.originalBasePrice || 0,
        fuelCharge: priceData.originalFuelCharge || 0,
        totalPrice: priceData.originalTotalPrice || 0
      });
      
      // The API already applies the multiplier for customer prices
      // Update the form with these values
      form.setValue("basePrice", priceData.basePrice);
      form.setValue("fuelCharge", priceData.fuelCharge);
      form.setValue("totalPrice", priceData.totalPrice);
      
      // CRITICAL: Update the package weight field with the billable weight
      // This ensures it's included when the form is submitted
      form.setValue("packageWeight", totalBillableWeight);
      
      // Also update billableWeight in a custom field if it exists
      if (form.getValues().hasOwnProperty("billableWeight")) {
        form.setValue("billableWeight", totalBillableWeight);
      }
      
      // Save updated price to the database immediately
      if (shipmentId) {
        try {
          // Save both customer prices and original cost prices to the database
          const updatePriceResponse = await apiRequest("PATCH", `/api/shipments/${shipmentId}`, {
            // Customer prices (with multiplier applied)
            basePrice: priceData.basePrice,
            fuelCharge: priceData.fuelCharge,
            totalPrice: priceData.totalPrice,
            
            // Original cost prices (before multiplier)
            originalBasePrice: priceData.originalBasePrice,
            originalFuelCharge: priceData.originalFuelCharge,
            originalTotalPrice: priceData.originalTotalPrice,
            
            // Applied multiplier
            appliedMultiplier: priceData.appliedMultiplier,
            
            // Package weight
            packageWeight: totalBillableWeight, // Use packageWeight as this is the standard field
            billableWeight: totalBillableWeight // Also include billableWeight if the API supports it
          });
          
          if (!updatePriceResponse.ok) {
            console.error("Failed to update price in database:", await updatePriceResponse.text());
            toast({
              title: "Warning",
              description: "Price calculated but not saved to database. Try saving the shipment.",
              variant: "destructive"
            });
          } else {
            console.log("Price successfully updated in database");
            
            // Also log the original and customer prices that were saved
            console.log("Saved prices:", {
              customer: {
                basePrice: priceData.basePrice,
                fuelCharge: priceData.fuelCharge,
                totalPrice: priceData.totalPrice
              },
              original: {
                basePrice: priceData.originalBasePrice,
                fuelCharge: priceData.originalFuelCharge,
                totalPrice: priceData.originalTotalPrice
              },
              multiplier: priceData.appliedMultiplier
            });
          }
        } catch (dbError) {
          console.error("Error updating price in database:", dbError);
        }
      }
      
      toast({
        title: "Price Updated",
        description: `New customer price: ${formatPrice(priceData.totalPrice)} (${totalBillableWeight.toFixed(2)} kg)`
      });
    } catch (error) {
      console.error("Error calculating price:", error);
      toast({
        title: "Price Calculation Error",
        description: error instanceof Error ? error.message : "An unknown error occurred",
        variant: "destructive"
      });
    }
  };

  // Update mutation
  const updateMutation = useMutation({
    mutationFn: async (params: { data: EditShipmentFormValues, __redirectAfterUpdate?: boolean }) => {
      if (!shipmentId) throw new Error("Shipment ID is required");
      
      const { data } = params;
      
      console.log(`Submitting update to /api/shipments/${shipmentId} with method PUT`);
      console.log("Submission data:", data);
      
      try {
        // Using PUT method instead of PATCH to match the server route
        const response = await apiRequest("PUT", `/api/shipments/${shipmentId}`, data);
        
        console.log("Response status:", response.status);
        
        if (!response.ok) {
          const errorData = await response.json();
          console.error("Update failed:", errorData);
          throw new Error(errorData.message || "Failed to update shipment");
        }
        
        return response.json();
      } catch (error) {
        console.error("Update error:", error);
        throw error;
      }
    },
    onSuccess: (_, variables) => {
      toast({
        title: "Shipment Updated",
        description: "The shipment has been successfully updated.",
      });
      
      // Invalidate the shipment query to refetch the data
      queryClient.invalidateQueries({ queryKey: [`/api/shipments/${shipmentId}`] });
      queryClient.invalidateQueries({ queryKey: ['/api/shipments'] });
      queryClient.invalidateQueries({ queryKey: ['/api/shipments/my'] });
      
      // Only redirect if this was a full form submission, not a package dimension update
      if (variables.__redirectAfterUpdate !== false) {
        setLocation(user?.role === "admin" ? "/admin-shipments" : "/my-shipments");
      }
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message || "Failed to update shipment",
        variant: "destructive",
      });
    },
  });

  // Submit handler
  const onSubmit = (data: EditShipmentFormValues) => {
    // Log the values being submitted
    console.log("Form onSubmit called with data:", data);
    
    // Make sure receiverEmail has a default value
    if (!data.receiverEmail || data.receiverEmail.trim() === '') {
      data.receiverEmail = "info@moogship.com";
    }
    
    // Include the original cost price values from state if available
    if (costPrices.basePrice > 0) {
      console.log("Including original cost prices in the update:", costPrices);
      data.originalBasePrice = costPrices.basePrice;
      data.originalFuelCharge = costPrices.fuelCharge;
      data.originalTotalPrice = costPrices.totalPrice;
    }
    
    // If the price calculated earlier provided a multiplier value, include it
    if (form.getValues().hasOwnProperty("appliedMultiplier")) {
      data.appliedMultiplier = form.getValues("appliedMultiplier");
    }
    
    // Fix: Copy itemCount to customsItemCount field for database storage
    if (data.itemCount) {
      console.log(`Setting customsItemCount to ${data.itemCount} from form itemCount field`);
      data.customsItemCount = data.itemCount;
    }
    
    // Log the final data being submitted
    console.log("Final submission data with prices:", data);
    
    // Directly initiate the mutation with redirect flag
    updateMutation.mutate({
      data,
      __redirectAfterUpdate: true
    });
  };

  return (
    <Layout user={user} hideMobileActions={true}>
      <div className="container mx-auto py-6">
        <Card className="bg-white rounded-lg shadow-md">
          <CardHeader className="border-b border-gray-100">
            <div className="flex justify-between items-center">
              {/* Desktop header */}
              <div className="hidden md:flex items-center">
                <Button 
                  variant="ghost" 
                  size="sm" 
                  className="mr-2"
                  onClick={() => setLocation(user?.role === "admin" ? "/admin-shipments" : "/my-shipments")}
                >
                  <ArrowLeft className="h-4 w-4 mr-1" />
                  Back
                </Button>
                <div>
                  <CardTitle className="text-xl font-semibold text-gray-900">
                    Edit Shipment {shipmentId}
                  </CardTitle>
                  <CardDescription className="text-gray-500">
                    Update shipping details and recipient information
                  </CardDescription>
                </div>
              </div>
              
              {/* Mobile header - simplified without extra icons */}
              <div className="md:hidden flex-1">
                <div className="flex items-center mb-1">
                  <Button 
                    variant="ghost" 
                    size="sm"
                    className="mr-2 -ml-3 h-9 w-9"
                    onClick={() => setLocation(user?.role === "admin" ? "/admin-shipments" : "/my-shipments")}
                  >
                    <ArrowLeft className="h-4 w-4" />
                    <span className="sr-only">Back</span>
                  </Button>
                  <CardTitle className="text-lg font-semibold">
                    Edit Shipment {shipmentId}
                  </CardTitle>
                </div>
                <CardDescription className="text-xs text-gray-500">
                  Update shipping details and recipient information
                </CardDescription>
              </div>
              
              {shipment?.status && (
                <div>
                  <Badge
                    className={
                      shipment.status === ShipmentStatus.APPROVED
                        ? "bg-green-100 text-green-800"
                        : shipment.status === ShipmentStatus.REJECTED
                        ? "bg-red-100 text-red-800"
                        : shipment.status === ShipmentStatus.IN_TRANSIT
                        ? "bg-blue-100 text-blue-800"
                        : shipment.status === ShipmentStatus.DELIVERED
                        ? "bg-purple-100 text-purple-800"
                        : "bg-amber-100 text-amber-800"
                    }
                  >
                    {shipment.status}
                  </Badge>
                </div>
              )}
            </div>
          </CardHeader>
          
          <CardContent className="p-4">
            {isLoadingShipment ? (
              <div className="flex justify-center items-center py-20">
                <Loader2 className="h-8 w-8 animate-spin text-blue-500" />
                <span className="ml-2 text-gray-500">Loading shipment details...</span>
              </div>
            ) : isErrorShipment ? (
              <div className="text-center py-10">
                <h3 className="text-lg font-medium text-gray-900">Error Loading Shipment</h3>
                <p className="text-gray-500 mt-1">
                  There was a problem fetching the shipment details.
                </p>
                <Button variant="outline" className="mt-4" onClick={() => setLocation(user?.role === "admin" ? "/admin-shipments" : "/my-shipments")}>
                  Return to Shipments
                </Button>
              </div>
            ) : shipment ? (
              <Form {...form}>
                <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
                  {/* Summary Info Card with Sender Information */}
                  <div className="grid md:grid-cols-2 gap-4 text-sm p-4 bg-blue-50/50 rounded-md border border-blue-100/50 mb-4">
                    <div className="space-y-2">
                      <div className="font-medium text-gray-700 border-b pb-1 mb-1">Shipment Details</div>
                      <div className="grid grid-cols-2 gap-x-3 gap-y-2">
                        <div className="text-gray-500">ID:</div>
                        <div className="font-medium">{shipment.id}</div>
                        
                        <div className="text-gray-500">User ID:</div>
                        <div className="font-medium">{shipment.userId}</div>
                        
                        <div className="text-gray-500">Created:</div>
                        <div className="font-medium">{formatDate(shipment.createdAt)}</div>
                        
                        {shipment.trackingNumber && (
                          <>
                            <div className="text-gray-500">Tracking Number:</div>
                            <div className="font-medium flex items-center group">
                              {shipment.trackingNumber}
                              <Copy 
                                className="h-3.5 w-3.5 ml-1.5 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                                onClick={() => copyToClipboard(shipment.trackingNumber, "Tracking Number")}
                              />
                            </div>
                          </>
                        )}
                      </div>
                    </div>
                    
                    <div className="space-y-2">
                      <div className="font-medium text-gray-700 border-b pb-1 mb-1">Sender Information</div>
                      <div className="grid grid-cols-2 gap-x-3 gap-y-2">
                        <div className="text-gray-500">Name:</div>
                        <div className="font-medium flex items-center group">
                          {form.getValues("senderName") || "N/A"}
                          {form.getValues("senderName") && (
                            <Copy 
                              className="h-3.5 w-3.5 ml-1.5 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                              onClick={() => copyToClipboard(form.getValues("senderName"), "Sender Name")}
                            />
                          )}
                        </div>
                        
                        <div className="text-gray-500">Phone:</div>
                        <div className="font-medium flex items-center group">
                          {form.getValues("senderPhone") || "N/A"}
                          {form.getValues("senderPhone") && (
                            <Copy 
                              className="h-3.5 w-3.5 ml-1.5 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                              onClick={() => copyToClipboard(form.getValues("senderPhone"), "Sender Phone")}
                            />
                          )}
                        </div>
                        
                        <div className="text-gray-500">Email:</div>
                        <div className="font-medium flex items-center group">
                          {form.getValues("senderEmail") || "N/A"}
                          {form.getValues("senderEmail") && (
                            <Copy 
                              className="h-3.5 w-3.5 ml-1.5 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                              onClick={() => copyToClipboard(form.getValues("senderEmail"), "Sender Email")}
                            />
                          )}
                        </div>
                        
                        <div className="text-gray-500">Address:</div>
                        <div className="font-medium flex items-center truncate group" title={form.getValues("senderAddress") || "N/A"}>
                          <span className="truncate">{form.getValues("senderAddress") || "N/A"}</span>
                          {form.getValues("senderAddress") && (
                            <Copy 
                              className="h-3.5 w-3.5 ml-1.5 flex-shrink-0 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                              onClick={() => copyToClipboard(form.getValues("senderAddress"), "Sender Address")}
                            />
                          )}
                        </div>
                        
                        <div className="text-gray-500">City/Postal:</div>
                        <div className="font-medium flex items-center group">
                          <span>
                            {form.getValues("senderCity")}{form.getValues("senderPostalCode") ? `, ${form.getValues("senderPostalCode")}` : ""}
                          </span>
                          {(form.getValues("senderCity") || form.getValues("senderPostalCode")) && (
                            <Copy 
                              className="h-3.5 w-3.5 ml-1.5 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                              onClick={() => copyToClipboard(
                                `${form.getValues("senderCity") || ""}${form.getValues("senderPostalCode") ? `, ${form.getValues("senderPostalCode")}` : ""}`, 
                                "Sender City/Postal"
                              )}
                            />
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Price information at the top for quick access */}
                  <div className="p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border border-blue-200 shadow-sm mb-4">
                    <div className="flex justify-between items-center">
                      <div>
                        <h3 className="font-medium">Shipping Price Information</h3>
                        <div className="text-gray-500 text-sm mt-1">
                          Based on {billableWeight.toFixed(2)} kg billable weight
                        </div>
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4 mt-3">
                      {/* Our Price (Admin only) */}
                      <div className="bg-white/60 rounded p-3 border border-blue-100">
                        <div className="text-sm font-medium text-gray-700 mb-1">Our Cost Price:</div>
                        <div className="text-xl font-bold text-blue-800">
                          {formatPrice(costPrices.totalPrice || shipment?.originalTotalPrice || 0)}
                        </div>
                        <div className="grid grid-cols-2 gap-2 mt-2 text-xs text-gray-500">
                          <div>Base: {formatPrice(costPrices.basePrice || shipment?.originalBasePrice || 0)}</div>
                          <div>Fuel: {formatPrice(costPrices.fuelCharge || shipment?.originalFuelCharge || 0)}</div>
                        </div>
                      </div>
                      
                      {/* Customer Price */}
                      <div className="bg-white/60 rounded p-3 border border-green-100">
                        <div className="text-sm font-medium text-gray-700 mb-1">
                          Customer Price: 
                          {shipmentCreator && shipment?.userId && (
                            <span className="ml-1 text-xs text-blue-600">
                              Created by {shipmentCreator.name} (×
                              <span className="font-semibold">
                                {(shipmentCreator.priceMultiplier || 1).toFixed(2)}
                              </span>
                              )
                            </span>
                          )}
                        </div>
                        <div className="text-xl font-bold text-green-700">
                          {formatPrice(form.getValues("totalPrice"))}
                        </div>
                        <div className="grid grid-cols-2 gap-2 mt-2 text-xs text-gray-500">
                          <div>Base: {formatPrice(form.getValues("basePrice"))}</div>
                          <div>Fuel: {formatPrice(form.getValues("fuelCharge"))}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Package information */}
                  <SectionCard 
                    title="Package Details" 
                    icon={Package}
                    defaultOpen={true}
                    bgColor="bg-gray-50"
                  >
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {/* Package Contents section moved here to replace Dimensions & Weight */}
                      <div>
                        <h4 className="text-sm font-medium text-gray-700 mb-2">Package Contents</h4>
                        <div className="grid grid-cols-1 gap-4">
                          <FormField
                            control={form.control}
                            name="packageContents"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Item Description</FormLabel>
                                <FormControl>
                                  <Textarea 
                                    placeholder="Describe the contents of the package" 
                                    className="resize-none"
                                    {...field}
                                    value={field.value || ''}
                                  />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                          
                          <div className="grid grid-cols-2 gap-4">
                            <FormField
                              control={form.control}
                              name="pieceCount"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel>Piece Count</FormLabel>
                                  <FormControl>
                                    <Input 
                                      type="number" 
                                      min="1" 
                                      step="1" 
                                      placeholder="Number of packages" 
                                      {...field}
                                      onChange={(e) => field.onChange(parseInt(e.target.value) || 1)}
                                    />
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                            
                            <FormField
                              control={form.control}
                              name="itemCount"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel>Item Count</FormLabel>
                                  <FormControl>
                                    <Input 
                                      type="number" 
                                      min="1" 
                                      step="1" 
                                      placeholder="Items in package" 
                                      {...field}
                                      onChange={(e) => field.onChange(parseInt(e.target.value) || 1)}
                                    />
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          </div>
                        </div>
                      </div>
                      
                      <div>
                        <div className="flex justify-between items-center mb-2">
                          <h4 className="text-sm font-medium text-gray-700">Weight Calculation</h4>
                          <Button 
                            type="button" 
                            variant="outline" 
                            size="sm"
                            className="h-7 px-2 text-xs"
                            onClick={calculatePrice}
                          >
                            <RefreshCcw className="mr-1 h-3 w-3" />
                            Recalculate Price
                          </Button>
                        </div>
                        <div className="bg-white rounded-md border border-gray-200 p-3 space-y-2">
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-600">Actual Weight:</span>
                            <span className="font-medium">
                              {/* Total of all packages actual weight */}
                              {packages.reduce((total, pkg) => {
                                const pkgWeight = typeof pkg.weight === 'number' ? pkg.weight : parseFloat(pkg.weight as string) || 0;
                                return total + pkgWeight;
                              }, 0).toFixed(2)} kg
                            </span>
                          </div>
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-600">Volumetric Weight:</span>
                            <span className="font-medium">
                              {/* Total of all packages volumetric weight */}
                              {packages.reduce((total, pkg) => {
                                const pkgVolWeight = typeof pkg.volumetricWeight === 'number' ? pkg.volumetricWeight : 0;
                                return total + pkgVolWeight;
                              }, 0).toFixed(2)} kg
                            </span>
                          </div>
                          <Separator className="my-1" />
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-600 font-medium">Billable Weight:</span>
                            <span className="font-bold">
                              {/* Total of all packages billable weight */}
                              {packages.reduce((total, pkg) => {
                                const pkgBillWeight = typeof pkg.billableWeight === 'number' ? pkg.billableWeight : 0;
                                return total + pkgBillWeight;
                              }, 0).toFixed(2)} kg
                            </span>
                          </div>
                        </div>
                        
                        <div className="mt-4">
                          <h4 className="text-sm font-medium text-gray-700 mb-2">Service Level</h4>
                          <FormField
                            control={form.control}
                            name="serviceLevel"
                            render={({ field }) => (
                              <FormItem>
                                <Select 
                                  onValueChange={field.onChange} 
                                  defaultValue={field.value}
                                  value={field.value}
                                >
                                  <FormControl>
                                    <SelectTrigger>
                                      <SelectValue placeholder="Select service level" />
                                    </SelectTrigger>
                                  </FormControl>
                                  <SelectContent>
                                    <SelectItem value={ServiceLevel.STANDARD}>
                                      Standard (5-7 days)
                                    </SelectItem>
                                    <SelectItem value={ServiceLevel.EXPRESS}>
                                      Express (3-4 days)
                                    </SelectItem>
                                    <SelectItem value={ServiceLevel.PRIORITY}>
                                      Priority (1-2 days)
                                    </SelectItem>
                                  </SelectContent>
                                </Select>
                                <FormMessage />
                              </FormItem>
                            )}
                          />
                        </div>
                      </div>
                    </div>
                    
                    {/* Package List Display */}
                    {isLoadingPackageItems ? (
                      <div className="mt-6 border-t border-gray-200 pt-4 flex justify-center">
                        <div className="flex items-center text-gray-500">
                          <Loader2 className="h-5 w-5 animate-spin mr-2" />
                          <span>Loading package details...</span>
                        </div>
                      </div>
                    ) : packages.length > 0 ? (
                      <div className="mt-6 border-t border-gray-200 pt-4">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="text-sm font-medium text-gray-700">Physical Packages ({form.getValues('pieceCount') || packages.length})</h4>
                          <div className="text-xs text-gray-500">
                            Showing {form.getValues('pieceCount') || packages.length} physical packages
                          </div>
                        </div>
                        <div className="space-y-3">
                          {packages.map((pkg, index) => (
                              <div 
                                key={pkg.id || index} 
                                className="bg-white rounded-md p-3 border border-gray-200 shadow-sm relative flex flex-col"
                              >
                                {/* Package number badge */}
                                <div className="absolute -top-2 -left-2 bg-blue-500 text-white px-2 py-0.5 rounded-full text-xs font-medium">
                                  #{index + 1}
                                </div>
                                
                                {/* Header row with package name, weight and edit button */}
                                <div className="flex justify-between items-center mb-1">
                                  <div className="font-medium text-gray-800 flex items-center mr-2 flex-1">
                                    {editingPackageId === pkg.id ? (
                                      <Input 
                                        className="h-7 py-1 text-sm"
                                        value={editingPackageData?.name}
                                        onChange={(e) => setEditingPackageData({
                                          ...editingPackageData!, 
                                          name: e.target.value
                                        })}
                                      />
                                    ) : (
                                      <span>{pkg.name || `Package #${index + 1}`}</span>
                                    )}
                                  </div>
                                  
                                  <Badge variant="outline" className="bg-blue-50 text-blue-700 border-blue-200 whitespace-nowrap mr-2">
                                    {typeof pkg.billableWeight === 'number' ? pkg.billableWeight.toFixed(2) : '0.00'} kg
                                  </Badge>
                                  
                                  {/* Edit/Save buttons for admin */}
                                  {isAdmin && (
                                    <div className="flex space-x-1">
                                      {editingPackageId === pkg.id ? (
                                        <div className="flex gap-1">
                                          <Button 
                                            size="icon"
                                            variant="outline" 
                                            onClick={async () => {
                                              try {
                                                // Validate package data before sending to the server
                                                const result = packageEditSchema.safeParse(editingPackageData);
                                                
                                                if (!result.success) {
                                                  // Show validation errors
                                                  const errors = result.error.format();
                                                  console.error("Package validation errors:", errors);
                                                  toast({
                                                    title: "Validation Error",
                                                    description: "Please check the package details and try again.",
                                                    variant: "destructive"
                                                  });
                                                  return;
                                                }
                                                
                                                // Save the package changes with validated data
                                                // Parse numeric values for calculations
                                                const weight = typeof result.data.weight === 'number' 
                                                  ? result.data.weight
                                                  : parseFloat(result.data.weight) || 0;
                                                
                                                const length = typeof result.data.length === 'number' 
                                                  ? result.data.length
                                                  : parseFloat(result.data.length) || 0;
                                                
                                                const width = typeof result.data.width === 'number' 
                                                  ? result.data.width
                                                  : parseFloat(result.data.width) || 0;
                                                
                                                const height = typeof result.data.height === 'number' 
                                                  ? result.data.height
                                                  : parseFloat(result.data.height) || 0;
                                                
                                                // Calculate volumetric and billable weights
                                                const volumetricWeight = calculateVolumetricWeight(length, width, height);
                                                const billableWeight = Math.max(weight, volumetricWeight);
                                                
                                                // Make sure each dimension value is handled properly
                                                const processedData = {
                                                  ...result.data,
                                                  // Ensure consistent formatting for numbers - these will be strings in the API
                                                  weight: weight.toString(),
                                                  length: length.toString(),
                                                  width: width.toString(),
                                                  height: height.toString(),
                                                  // Include the calculated weights for UI state
                                                  volumetricWeight: volumetricWeight,
                                                  billableWeight: billableWeight
                                                };
                                                
                                                console.log("Sending package data to API with calculated weights:", processedData);
                                                
                                                const response = await fetch(`/api/packages/${pkg.id}`, {
                                                  method: 'PUT',
                                                  headers: {
                                                    'Content-Type': 'application/json',
                                                  },
                                                  body: JSON.stringify(processedData)
                                                });
                                                
                                                if (response.ok) {
                                                  toast({
                                                    title: "Package updated",
                                                    description: "The package details have been updated successfully.",
                                                  });
                                                  setEditingPackageId(null);
                                                  setEditingPackageData(null);
                                                  // Reset the calculated weight values
                                                  setEditingVolumetricWeight(0);
                                                  setEditingBillableWeight(0);
                                                  // Refresh package data
                                                  refreshPackages();
                                                } else {
                                                  toast({
                                                    title: "Update failed",
                                                    description: "Failed to update package details. Please try again.",
                                                    variant: "destructive"
                                                  });
                                                }
                                              } catch (error) {
                                                console.error("Error updating package:", error);
                                                toast({
                                                  title: "Update failed",
                                                  description: "An error occurred while updating the package.",
                                                  variant: "destructive"
                                                });
                                              }
                                            }}
                                            className="h-6 w-6"
                                            title="Save changes"
                                          >
                                            <Save className="h-3 w-3" />
                                            <span className="sr-only">Save</span>
                                          </Button>
                                          <Button 
                                            size="icon"
                                            variant="ghost" 
                                            onClick={() => {
                                              setEditingPackageId(null);
                                              setEditingPackageData(null);
                                              // Reset the calculated weight values
                                              setEditingVolumetricWeight(0);
                                              setEditingBillableWeight(0);
                                            }}
                                            className="h-6 w-6"
                                            title="Cancel editing"
                                          >
                                            <X className="h-3 w-3" />
                                            <span className="sr-only">Cancel</span>
                                          </Button>
                                        </div>
                                      ) : (
                                        <Button 
                                          size="icon"
                                          variant="ghost" 
                                          onClick={() => {
                                            setEditingPackageId(pkg.id);
                                            
                                            // Get the current weight and dimensions as numbers
                                            const weight = typeof pkg.weight === 'number' ? pkg.weight : 0;
                                            const length = typeof pkg.length === 'number' ? pkg.length : 0;
                                            const width = typeof pkg.width === 'number' ? pkg.width : 0;
                                            const height = typeof pkg.height === 'number' ? pkg.height : 0;
                                            
                                            // Calculate volumetric and billable weights
                                            const volWeight = calculateVolumetricWeight(length, width, height);
                                            const billWeight = Math.max(weight, volWeight);
                                            
                                            // Update the editing states
                                            setEditingVolumetricWeight(volWeight);
                                            setEditingBillableWeight(billWeight);
                                            
                                            setEditingPackageData({
                                              name: pkg.name || `Package #${index + 1}`,
                                              description: pkg.description || '',
                                              notes: pkg.notes || '',
                                              weight: weight,
                                              length: length,
                                              width: width,
                                              height: height
                                            });
                                          }}
                                          className="h-6 w-6"
                                          title="Edit package"
                                        >
                                          <Edit className="h-3 w-3" />
                                          <span className="sr-only">Edit</span>
                                        </Button>
                                      )}
                                    </div>
                                  )}
                                </div>
                                
                                {/* Package dimensions - compact view in non-edit mode */}
                                {editingPackageId === pkg.id ? (
                                  <div className="space-y-3">
                                    <div className="grid grid-cols-4 gap-2">
                                      <div>
                                        <Label className="text-xs">Length (cm)</Label>
                                        <Input 
                                          type="number"
                                          className="h-7 py-1 text-sm"
                                          value={editingPackageData?.length}
                                          onChange={(e) => {
                                            const newLength = parseFloat(e.target.value);
                                            const width = editingPackageData?.width || 0;
                                            const height = editingPackageData?.height || 0;
                                            const weight = editingPackageData?.weight || 0;
                                            
                                            // Calculate new volumetric weight
                                            const volWeight = calculateVolumetricWeight(newLength, width, height);
                                            const billWeight = Math.max(weight, volWeight);
                                            
                                            // Update state
                                            setEditingVolumetricWeight(volWeight);
                                            setEditingBillableWeight(billWeight);
                                            
                                            // Update form data
                                            setEditingPackageData({
                                              ...editingPackageData!, 
                                              length: newLength
                                            });
                                          }}
                                        />
                                      </div>
                                      <div>
                                        <Label className="text-xs">Width (cm)</Label>
                                        <Input 
                                          type="number"
                                          className="h-7 py-1 text-sm"
                                          value={editingPackageData?.width}
                                          onChange={(e) => {
                                            const newWidth = parseFloat(e.target.value);
                                            const length = editingPackageData?.length || 0;
                                            const height = editingPackageData?.height || 0;
                                            const weight = editingPackageData?.weight || 0;
                                            
                                            // Calculate new volumetric weight
                                            const volWeight = calculateVolumetricWeight(length, newWidth, height);
                                            const billWeight = Math.max(weight, volWeight);
                                            
                                            // Update state
                                            setEditingVolumetricWeight(volWeight);
                                            setEditingBillableWeight(billWeight);
                                            
                                            // Update form data
                                            setEditingPackageData({
                                              ...editingPackageData!, 
                                              width: newWidth
                                            });
                                          }}
                                        />
                                      </div>
                                      <div>
                                        <Label className="text-xs">Height (cm)</Label>
                                        <Input 
                                          type="number"
                                          className="h-7 py-1 text-sm"
                                          value={editingPackageData?.height}
                                          onChange={(e) => {
                                            const newHeight = parseFloat(e.target.value);
                                            const length = editingPackageData?.length || 0;
                                            const width = editingPackageData?.width || 0;
                                            const weight = editingPackageData?.weight || 0;
                                            
                                            // Calculate new volumetric weight
                                            const volWeight = calculateVolumetricWeight(length, width, newHeight);
                                            const billWeight = Math.max(weight, volWeight);
                                            
                                            // Update state
                                            setEditingVolumetricWeight(volWeight);
                                            setEditingBillableWeight(billWeight);
                                            
                                            // Update form data
                                            setEditingPackageData({
                                              ...editingPackageData!, 
                                              height: newHeight
                                            });
                                          }}
                                        />
                                      </div>
                                      <div>
                                        <Label className="text-xs">Weight (kg)</Label>
                                        <Input 
                                          type="number"
                                          step="0.1"
                                          className="h-7 py-1 text-sm"
                                          value={editingPackageData?.weight}
                                          onChange={(e) => {
                                            const newWeight = parseFloat(e.target.value);
                                            const length = editingPackageData?.length || 0;
                                            const width = editingPackageData?.width || 0;
                                            const height = editingPackageData?.height || 0;
                                            
                                            // Calculate volumetric weight (unchanged)
                                            const volWeight = calculateVolumetricWeight(length, width, height);
                                            // Update billable weight using the new actual weight
                                            const billWeight = Math.max(newWeight, volWeight);
                                            
                                            // Update state
                                            setEditingVolumetricWeight(volWeight);
                                            setEditingBillableWeight(billWeight);
                                            
                                            // Update form data
                                            setEditingPackageData({
                                              ...editingPackageData!, 
                                              weight: newWeight
                                            });
                                          }}
                                        />
                                      </div>
                                    </div>

                                    {/* Real-time calculated weights display */}
                                    <div className="bg-gray-50 p-2 rounded-md border border-gray-100 text-xs">
                                      <div className="flex justify-between items-center">
                                        <span className="text-gray-600">Volumetric Weight:</span>
                                        <span className="font-medium">{editingVolumetricWeight.toFixed(2)} kg</span>
                                      </div>
                                      <div className="flex justify-between items-center mt-1">
                                        <span className="text-gray-600">Billable Weight:</span>
                                        <span className="font-semibold text-blue-700">{editingBillableWeight.toFixed(2)} kg</span>
                                      </div>
                                      {editingVolumetricWeight > (editingPackageData?.weight || 0) && (
                                        <div className="mt-1 text-blue-600 text-[10px] flex items-center">
                                          <Info className="h-3 w-3 mr-1" />
                                          <span className="italic">Volumetric weight will be applied</span>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                ) : (
                                  <div className="flex flex-wrap gap-x-4 gap-y-1 mt-1 text-xs">
                                    <div className="flex items-center">
                                      <Box className="h-3 w-3 mr-1 text-gray-500" />
                                      <span className="text-gray-500 mr-1">Dimensions:</span>
                                      <span className="font-medium bg-gray-100 px-1.5 py-0.5 rounded">
                                        {typeof pkg.length === 'number' ? pkg.length : 0} × {typeof pkg.width === 'number' ? pkg.width : 0} × {typeof pkg.height === 'number' ? pkg.height : 0} cm
                                      </span>
                                    </div>
                                    <div className="flex items-center">
                                      <Weight className="h-3 w-3 mr-1 text-gray-500" />
                                      <span className="text-gray-500 mr-1">Weight:</span>
                                      <span className="font-medium bg-gray-100 px-1.5 py-0.5 rounded">
                                        {typeof pkg.weight === 'number' ? pkg.weight.toString() : '0.00'} kg
                                      </span>
                                    </div>
                                    {typeof pkg.volumetricWeight === 'number' && typeof pkg.weight === 'number' && 
                                      pkg.volumetricWeight > pkg.weight && (
                                      <div className="flex items-center text-blue-600 w-full mt-0.5">
                                        <Info className="h-3 w-3 mr-1" />
                                        <span className="italic">
                                          Volumetric weight ({pkg.volumetricWeight.toFixed(2)} kg) applied
                                        </span>
                                      </div>
                                    )}
                                  </div>
                                )}
                                
                                {/* Description/Notes area - editable in edit mode */}
                                {editingPackageId === pkg.id ? (
                                  <div className="mt-2 pt-2 border-t border-gray-100">
                                    <Label className="text-xs mb-1 block">Description</Label>
                                    <Textarea 
                                      className="resize-none h-12 text-xs"
                                      placeholder="Package description"
                                      value={editingPackageData?.description}
                                      onChange={(e) => setEditingPackageData({
                                        ...editingPackageData!, 
                                        description: e.target.value
                                      })}
                                    />
                                    
                                    <Label className="text-xs mb-1 mt-2 block">Admin Notes</Label>
                                    <Textarea 
                                      className="resize-none h-12 text-xs"
                                      placeholder="Internal notes (only visible to admins)"
                                      value={editingPackageData?.notes}
                                      onChange={(e) => setEditingPackageData({
                                        ...editingPackageData!, 
                                        notes: e.target.value
                                      })}
                                    />
                                  </div>
                                ) : (
                                  <>
                                    {/* Show description and notes in a compact format */}
                                    {(pkg.description || (isAdmin && pkg.notes)) && (
                                      <div className="mt-1.5 text-xs">
                                        {pkg.description && (
                                          <div className="flex items-start mt-1">
                                            <FileText className="h-3 w-3 mr-1 text-blue-500 mt-0.5 flex-shrink-0" />
                                            <span className="text-gray-600">{pkg.description}</span>
                                          </div>
                                        )}
                                        
                                        {isAdmin && pkg.notes && (
                                          <div className="flex items-start mt-1 bg-yellow-50/50 p-1 rounded">
                                            <StickyNote className="h-3 w-3 mr-1 text-amber-500 mt-0.5 flex-shrink-0" />
                                            <span className="text-gray-600">{pkg.notes}</span>
                                          </div>
                                        )}
                                      </div>
                                    )}
                                  </>
                                )}
                              </div>
                          ))}
                        </div>
                        
                        {/* Total summary at the bottom */}
                        <div className="bg-blue-50 p-3 rounded-md mt-4 border border-blue-100">
                          <div className="flex justify-between items-center">
                            <div className="font-medium">Total Billable Weight:</div>
                            <div className="font-semibold text-blue-800">
                              {packages.reduce((total, pkg) => {
                                const weight = typeof pkg.billableWeight === 'number' ? pkg.billableWeight : 0;
                                return total + weight;
                              }, 0).toFixed(2)} kg
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <div className="mt-6 border-t border-gray-200 pt-4 text-center text-gray-500 py-4">
                        No packages found for this shipment
                      </div>
                    )}
                  </SectionCard>
                  
                  {/* Receiver Information */}
                  <SectionCard 
                    title="Receiver Information" 
                    icon={UserRound}
                    defaultOpen={true}
                    bgColor="bg-green-50/30"
                  >
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <FormField
                          control={form.control}
                          name="receiverName"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Recipient Name</FormLabel>
                              <FormControl>
                                <div className="relative group">
                                  <Input 
                                    placeholder="Enter recipient name" 
                                    {...field}
                                    value={field.value || ''}
                                  />
                                  {field.value && (
                                    <Copy 
                                      className="absolute right-2 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                                      onClick={() => copyToClipboard(field.value, "Recipient Name")}
                                    />
                                  )}
                                </div>
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        
                        <FormField
                          control={form.control}
                          name="receiverPhone"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Phone Number</FormLabel>
                              <FormControl>
                                <div className="relative group">
                                  <Input 
                                    placeholder="Enter phone number" 
                                    {...field}
                                    value={field.value || ''}
                                  />
                                  {field.value && (
                                    <Copy 
                                      className="absolute right-2 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                                      onClick={() => copyToClipboard(field.value, "Phone Number")}
                                    />
                                  )}
                                </div>
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      </div>
                      
                      <FormField
                        control={form.control}
                        name="receiverEmail"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Email</FormLabel>
                            <FormControl>
                              <div className="relative group">
                                <Input 
                                  type="email" 
                                  placeholder="Enter email address" 
                                  {...field}
                                  // If no email is provided, use info@moogship.com as default
                                  onBlur={(e) => {
                                    if (!e.target.value.trim()) {
                                      field.onChange("info@moogship.com");
                                    }
                                  }}
                                  value={field.value || ''}
                                />
                                {field.value && (
                                  <Copy 
                                    className="absolute right-2 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                                    onClick={() => copyToClipboard(field.value, "Email Address")}
                                  />
                                )}
                              </div>
                            </FormControl>
                            <FormDescription className="text-xs">
                              If not provided, will default to info@moogship.com
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      
                      <FormField
                        control={form.control}
                        name="receiverAddress"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Address</FormLabel>
                            <FormControl>
                              <div className="relative group">
                                <Input 
                                  placeholder="Enter street address" 
                                  {...field}
                                  value={field.value || ''}
                                />
                                {field.value && (
                                  <Copy 
                                    className="absolute right-2 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                                    onClick={() => copyToClipboard(field.value, "Address")}
                                  />
                                )}
                              </div>
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      
                      <div className="grid grid-cols-2 gap-4">
                        <FormField
                          control={form.control}
                          name="receiverCity"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>City</FormLabel>
                              <FormControl>
                                <div className="relative group">
                                  <Input 
                                    placeholder="Enter city" 
                                    {...field}
                                    value={field.value || ''}
                                  />
                                  {field.value && (
                                    <Copy 
                                      className="absolute right-2 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                                      onClick={() => copyToClipboard(field.value, "City")}
                                    />
                                  )}
                                </div>
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        
                        <FormField
                          control={form.control}
                          name="receiverState"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>State/Province</FormLabel>
                              <FormControl>
                                <div className="relative group">
                                  <Input 
                                    placeholder="Enter state or province" 
                                    {...field}
                                    value={field.value || ''}
                                  />
                                  {field.value && (
                                    <Copy 
                                      className="absolute right-2 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                                      onClick={() => copyToClipboard(field.value, "State/Province")}
                                    />
                                  )}
                                </div>
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      </div>
                      
                      <div className="grid grid-cols-2 gap-4">
                        <FormField
                          control={form.control}
                          name="receiverPostalCode"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Postal/ZIP Code</FormLabel>
                              <FormControl>
                                <div className="relative group">
                                  <Input 
                                    placeholder="Enter postal code" 
                                    {...field}
                                    value={field.value || ''}
                                  />
                                  {field.value && (
                                    <Copy 
                                      className="absolute right-2 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 cursor-pointer hover:text-blue-500 transition-colors opacity-0 group-hover:opacity-100" 
                                      onClick={() => copyToClipboard(field.value, "Postal/ZIP Code")}
                                    />
                                  )}
                                </div>
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        
                        <FormField
                          control={form.control}
                          name="receiverCountry"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Country</FormLabel>
                              <Select 
                                onValueChange={field.onChange} 
                                defaultValue={field.value}
                                value={field.value}
                              >
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue placeholder="Select a country" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  {COUNTRIES.map((country) => (
                                    <SelectItem key={country.code} value={country.code}>
                                      {country.name}
                                    </SelectItem>
                                  ))}
                                </SelectContent>
                              </Select>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      </div>
                    </div>
                  </SectionCard>
                  
                  {/* Customs Information */}
                  <SectionCard 
                    title="Customs Information" 
                    icon={CreditCard}
                    bgColor="bg-amber-50/30"
                  >
                    <div className="space-y-4">
                      <FormField
                        control={form.control}
                        name="gtip"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>GTIP Code</FormLabel>
                            <FormControl>
                              <Input 
                                type="text"
                                inputMode="decimal"
                                placeholder="Enter GTIP/HS code (e.g. 1234.56.78)" 
                                {...field}
                                value={field.value || ''}
                                onFocus={(e) => e.target.select()}
                              />
                            </FormControl>
                            <FormDescription className="text-xs">
                              Harmonized System (HS) code for customs
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <FormField
                          control={form.control}
                          name="customsValue"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Customs Value</FormLabel>
                              <FormControl>
                                <Input 
                                  type="text" 
                                  inputMode="decimal"
                                  placeholder="Value (e.g. 123.45)" 
                                  value={(field.value / 100).toFixed(2)}
                                  onChange={(e) => {
                                    // Handle the string input and convert to cents for storage
                                    const inputValue = e.target.value;
                                    if (inputValue && !isNaN(Number(inputValue))) {
                                      const dollars = parseFloat(inputValue);
                                      const cents = Math.round(dollars * 100);
                                      field.onChange(cents);
                                    } else {
                                      field.onChange(0);
                                    }
                                  }}
                                  onBlur={(e) => {
                                    // Ensure proper formatting when leaving the field
                                    const value = field.value || 0;
                                    if (value && typeof value === 'number') {
                                      // Force toFixed(2) display format
                                      e.target.value = (value / 100).toFixed(2);
                                    }
                                  }}
                                  onFocus={(e) => e.target.select()}
                                />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        
                        <FormField
                          control={form.control}
                          name="currency"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Currency</FormLabel>
                              <Select 
                                onValueChange={field.onChange} 
                                value={field.value || 'USD'}
                              >
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue placeholder="Select currency" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  {CURRENCIES.map((currency) => (
                                    <SelectItem key={currency.code} value={currency.code}>
                                      {currency.symbol} {currency.name}
                                    </SelectItem>
                                  ))}
                                </SelectContent>
                              </Select>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      </div>
                    </div>
                  </SectionCard>
                  
                  {/* Status field (for admin only) */}
                  {isAdmin && (
                    <div className="bg-gray-50 rounded-lg border p-4 mt-4">
                      <h3 className="text-sm font-medium text-gray-700 mb-2">Shipment Status</h3>
                      <div className="space-y-2">
                        <FormField
                          control={form.control}
                          name="status"
                          render={({ field }) => (
                            <FormItem>
                              <Select 
                                onValueChange={field.onChange} 
                                defaultValue={field.value}
                                value={field.value}
                              >
                                <FormControl>
                                  <SelectTrigger className="bg-white">
                                    <SelectValue placeholder="Select status" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  <SelectItem value={ShipmentStatus.PENDING} className="text-amber-600 font-medium">
                                    Pending
                                  </SelectItem>
                                  <SelectItem value={ShipmentStatus.APPROVED} className="text-green-600 font-medium">
                                    Approved
                                  </SelectItem>
                                  <SelectItem value={ShipmentStatus.REJECTED} className="text-red-600 font-medium">
                                    Rejected
                                  </SelectItem>
                                </SelectContent>
                              </Select>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      </div>
                    </div>
                  )
                      
                  
                  {/* Rejection Reason field - only show if status is REJECTED */}
                  {isAdmin && form.watch("status") === ShipmentStatus.REJECTED && (
                    <div className="mt-4">
                      <FormField
                        control={form.control}
                        name="rejectionReason"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Rejection Reason</FormLabel>
                            <FormControl>
                              <Textarea 
                                placeholder="Enter reason for rejection" 
                                className="bg-white resize-none"
                                {...field}
                                value={field.value || ''}
                              />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>
                  )}
                  
                  {/* Action buttons */}
                  <div className="flex justify-end space-x-4 pt-4">
                    <Button 
                      type="button" 
                      variant="outline"
                      onClick={() => setLocation(user?.role === "admin" ? "/admin-shipments" : "/my-shipments")}
                    >
                      Cancel
                    </Button>
                    <Button 
                      type="button" 
                      disabled={updateMutation.isPending}
                      className="bg-blue-600 hover:bg-blue-700"
                      onClick={() => {
                        console.log("Update button clicked, preparing data...");
                        
                        // Get the form data first
                        const formData = form.getValues();
                        
                        // Ensure receiverEmail has a default value before validation
                        if (!formData.receiverEmail || formData.receiverEmail.trim() === '') {
                          formData.receiverEmail = "info@moogship.com";
                          // Update the form value
                          form.setValue("receiverEmail", "info@moogship.com");
                        }
                        
                        console.log("Submitting form data directly:", formData);
                        
                        // Send the data directly without validation as we've already pre-processed it
                        // The validation is still occurring in the mutation via Zod
                        try {
                          updateMutation.mutate({
                            data: formData,
                            __redirectAfterUpdate: true
                          });
                        } catch (error) {
                          console.error("Error submitting form:", error);
                          toast({
                            title: "Submission Error",
                            description: "An error occurred while submitting the form. Please try again.",
                            variant: "destructive",
                          });
                        }
                      }}
                    >
                      {updateMutation.isPending && (
                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                      )}
                      Update Shipment
                    </Button>
                  </div>
                </form>
              </Form>
            ) : null}
          </CardContent>
        </Card>
      </div>
    </Layout>
  );
};

export default withAuth(ShipmentEditContent);